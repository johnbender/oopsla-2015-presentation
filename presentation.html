<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Declarative Fence Insertion</title>
<meta name="author" content="(John Bender, Jens Palsberg - UCLA  (export-snippet (:back-end html :value  <br/>  :begin 35 :end 52 :post-blank 1 :parent #0)) Mohsen Lesani - MIT  (export-snippet (:back-end html :value  <br/> <img src='assets/images/badge.png' class='badge'></img>  :begin 72 :end 144 :post-blank 0 :parent #0)))"/>
<style type="text/css">
.underline { text-decoration: underline; }
</style>
<link rel="stylesheet" href="assets/reveal/css/reveal.css"/>
<link rel="stylesheet" href="assets/reveal/css/theme/white.css" id="theme"/>

<!-- If the query includes 'print-pdf', include the PDF print sheet -->
<script>
    if( window.location.search.match( /print-pdf/gi ) ) {
        var link = document.createElement( 'link' );
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = 'assets/reveal/css/print/pdf.css';
        document.getElementsByTagName( 'head' )[0].appendChild( link );
    }
</script>
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<link rel="stylesheet" type="text/css" href="assets/style.css" />
</head>
<body>
<div class="reveal">
<div class="slides">
<section id="sec-title-slide">
<h1>Declarative Fence Insertion</h1>
<h2>John Bender, Jens Palsberg - UCLA  <br/>  Mohsen Lesani - MIT  <br/> <img src='assets/images/badge.png' class='badge'></img> </h2>
<h2><a href="mailto:"></a></h2>
<h2></h2>
</section>
</section>
</section>
<section>
<section id="slide-orgheadline1">
<h3 id="orgheadline1"><code>LockOne</code> mutex</h3>
<p>
The Art of Multiprocessor Programming, 2.3.1
</p>

<p>
Maurice Herlihy &amp; Nir Shavit, 2012
</p>

<div class="org-src-container">

<pre  class="src src-java"><span class="linenr"> 1: </span><span style="color: #268bd2; font-weight: bold;">class</span> <span style="color: #af005f; font-weight: bold;">LockOne</span> <span style="color: #268bd2; font-weight: bold;">implements</span> <span style="color: #af005f; font-weight: bold;">Lock</span> <span style="color: #268bd2;">{</span>
<span class="linenr"> 2: </span>  <span style="color: #268bd2; font-weight: bold;">private</span> <span style="color: #af005f; font-weight: bold;">boolean</span><span style="color: #8700af;">[]</span> <span style="color: #af5fd7;">flag</span> = <span style="color: #268bd2; font-weight: bold;">new</span> <span style="color: #af005f; font-weight: bold;">boolean</span><span style="color: #8700af;">[</span><span style="color: #8700af;">2</span><span style="color: #8700af;">]</span>;
<span class="linenr"> 3: </span>
<span class="linenr"> 4: </span>  <span style="color: #268bd2; font-weight: bold;">public</span> <span style="color: #af005f; font-weight: bold;">void</span> <span style="color: #8700af; font-weight: bold;">lock</span><span style="color: #8700af;">()</span> <span style="color: #8700af;">{</span>
<span class="linenr"> 5: </span>    <span style="color: #af005f; font-weight: bold;">int</span> <span style="color: #af5fd7;">i</span> = ThreadID.get<span style="color: #2aa198;">()</span>;
<span class="linenr"> 6: </span>    <span style="color: #af005f; font-weight: bold;">int</span> <span style="color: #af5fd7;">j</span> = <span style="color: #8700af;">1</span>-i;
<span class="linenr"> 7: </span>    flag<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span> = <span style="color: #8700af;">true</span>;
<span class="linenr"> 8: </span>    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #2aa198;">(</span>flag<span style="color: #5faf00;">[</span>j<span style="color: #5faf00;">]</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{}</span>
<span class="linenr"> 9: </span>  <span style="color: #8700af;">}</span>
<span class="linenr">10: </span>
<span class="linenr">11: </span>  <span style="color: #268bd2; font-weight: bold;">public</span> <span style="color: #af005f; font-weight: bold;">void</span> <span style="color: #8700af; font-weight: bold;">unlock</span><span style="color: #8700af;">()</span> <span style="color: #8700af;">{</span>
<span class="linenr">12: </span>    <span style="color: #af005f; font-weight: bold;">int</span> <span style="color: #af5fd7;">i</span> = ThreadID.get<span style="color: #2aa198;">()</span>;
<span class="linenr">13: </span>    flag<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span> = <span style="color: #8700af;">false</span>;
<span class="linenr">14: </span>  <span style="color: #8700af;">}</span>
<span class="linenr">15: </span><span style="color: #268bd2;">}</span>
</pre>
</div>

<aside class="notes">
<ul>
<li>Our work focuses on performance critical concurrent algorithms</li>

<li>To illustrate the problem we have an example of one such algorithm
from the art of multiproc programming</li>

<li>by Maurice Herlihy and Nir Shavit</li>

<li>lock intended to guarantee mutual exclusion for two threads</li>
<li>notably doesn't guarantee progress, only safety</li>

</ul>

</aside>

</section>
</section>
<section>
<section id="slide-orgheadline2">
<h3 id="orgheadline2"><code>LockOne</code> mutex</h3>
<p>
The Art of Multiprocessor Programming, 2.3.1
</p>

<p>
Maurice Herlihy &amp; Nir Shavit, 2012
</p>

<div class="org-src-container">

<pre  class="src src-java"><span class="linenr"> 1: </span><span style="color: #268bd2; font-weight: bold;">class</span> <span style="color: #af005f; font-weight: bold;">LockOne</span> <span style="color: #268bd2; font-weight: bold;">implements</span> <span style="color: #af005f; font-weight: bold;">Lock</span> <span style="color: #268bd2;">{</span>
<span class="linenr"> 2: </span>  <span style="color: #268bd2; font-weight: bold;">private</span> <span style="color: #af005f; font-weight: bold;">boolean</span><span style="color: #8700af;">[]</span> <span style="color: #af5fd7;">flag</span> = <span style="color: #268bd2; font-weight: bold;">new</span> <span style="color: #af005f; font-weight: bold;">boolean</span><span style="color: #8700af;">[</span><span style="color: #8700af;">2</span><span style="color: #8700af;">]</span>;
<span class="linenr"> 3: </span>                                       &#9650;
<span class="linenr"> 4: </span>  <span style="color: #268bd2; font-weight: bold;">public</span> <span style="color: #af005f; font-weight: bold;">void</span> lock<span style="color: #8700af;">()</span> <span style="color: #8700af;">{</span>
<span class="linenr"> 5: </span>    <span style="color: #af005f; font-weight: bold;">int</span> <span style="color: #af5fd7;">i</span> = ThreadID.get<span style="color: #2aa198;">()</span>;
<span class="linenr"> 6: </span>    <span style="color: #af005f; font-weight: bold;">int</span> <span style="color: #af5fd7;">j</span> = <span style="color: #8700af;">1</span>-i;
<span class="linenr"> 7: </span>    flag<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span> = <span style="color: #8700af;">true</span>;
<span class="linenr"> 8: </span>    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #2aa198;">(</span>flag<span style="color: #5faf00;">[</span>j<span style="color: #5faf00;">]</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{}</span>
<span class="linenr"> 9: </span>  <span style="color: #8700af;">}</span>
<span class="linenr">10: </span>
<span class="linenr">11: </span>  <span style="color: #268bd2; font-weight: bold;">public</span> <span style="color: #af005f; font-weight: bold;">void</span> <span style="color: #8700af; font-weight: bold;">unlock</span><span style="color: #8700af;">()</span> <span style="color: #8700af;">{</span>
<span class="linenr">12: </span>    <span style="color: #af005f; font-weight: bold;">int</span> <span style="color: #af5fd7;">i</span> = ThreadID.get<span style="color: #2aa198;">()</span>;
<span class="linenr">13: </span>    flag<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span> = <span style="color: #8700af;">false</span>;
<span class="linenr">14: </span>  <span style="color: #8700af;">}</span>
<span class="linenr">15: </span><span style="color: #268bd2;">}</span>
</pre>
</div>

<aside class="notes">
<p>
There are two flags, one for each thread
</p>

</aside>
</section>
</section>
<section>
<section id="slide-orgheadline3">
<h3 id="orgheadline3"><code>LockOne</code> mutex</h3>
<p>
The Art of Multiprocessor Programming, 2.3.1
</p>

<p>
Maurice Herlihy &amp; Nir Shavit, 2012
</p>

<div class="org-src-container">

<pre  class="src src-java"><span class="linenr"> 1: </span><span style="color: #268bd2; font-weight: bold;">class</span> <span style="color: #af005f; font-weight: bold;">LockOne</span> <span style="color: #268bd2; font-weight: bold;">implements</span> <span style="color: #af005f; font-weight: bold;">Lock</span> <span style="color: #268bd2;">{</span>
<span class="linenr"> 2: </span>  <span style="color: #268bd2; font-weight: bold;">private</span> <span style="color: #af005f; font-weight: bold;">boolean</span><span style="color: #8700af;">[]</span> <span style="color: #af5fd7;">flag</span> = <span style="color: #268bd2; font-weight: bold;">new</span> <span style="color: #af005f; font-weight: bold;">boolean</span><span style="color: #8700af;">[</span><span style="color: #8700af;">2</span><span style="color: #8700af;">]</span>;
<span class="linenr"> 3: </span>
<span class="linenr"> 4: </span>  <span style="color: #268bd2; font-weight: bold;">public</span> <span style="color: #af005f; font-weight: bold;">void</span> <span style="color: #8700af; font-weight: bold;">lock</span><span style="color: #8700af;">()</span> <span style="color: #8700af;">{</span>
<span class="linenr"> 5: </span>&#9654;   <span style="color: #af005f; font-weight: bold;">int</span> i = ThreadID.get<span style="color: #2aa198;">()</span>;
<span class="linenr"> 6: </span>    <span style="color: #af005f; font-weight: bold;">int</span> <span style="color: #af5fd7;">j</span> = <span style="color: #8700af;">1</span>-i;
<span class="linenr"> 7: </span>    flag<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span> = <span style="color: #8700af;">true</span>;
<span class="linenr"> 8: </span>    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #2aa198;">(</span>flag<span style="color: #5faf00;">[</span>j<span style="color: #5faf00;">]</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{}</span>
<span class="linenr"> 9: </span>  <span style="color: #8700af;">}</span>
<span class="linenr">10: </span>
<span class="linenr">11: </span>  <span style="color: #268bd2; font-weight: bold;">public</span> <span style="color: #af005f; font-weight: bold;">void</span> <span style="color: #8700af; font-weight: bold;">unlock</span><span style="color: #8700af;">()</span> <span style="color: #8700af;">{</span>
<span class="linenr">12: </span>    <span style="color: #af005f; font-weight: bold;">int</span> <span style="color: #af5fd7;">i</span> = ThreadID.get<span style="color: #2aa198;">()</span>;
<span class="linenr">13: </span>    flag<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span> = <span style="color: #8700af;">false</span>;
<span class="linenr">14: </span>  <span style="color: #8700af;">}</span>
<span class="linenr">15: </span><span style="color: #268bd2;">}</span>
</pre>
</div>


<aside class="notes">
<p>
Each thread gets it's own id &#x2026;
</p>

</aside>
</section>
</section>
<section>
<section id="slide-orgheadline4">
<h3 id="orgheadline4"><code>LockOne</code> mutex</h3>
<p>
The Art of Multiprocessor Programming, 2.3.1
</p>

<p>
Maurice Herlihy &amp; Nir Shavit, 2012
</p>

<div class="org-src-container">

<pre  class="src src-java"><span class="linenr"> 1: </span><span style="color: #268bd2; font-weight: bold;">class</span> <span style="color: #af005f; font-weight: bold;">LockOne</span> <span style="color: #268bd2; font-weight: bold;">implements</span> <span style="color: #af005f; font-weight: bold;">Lock</span> <span style="color: #268bd2;">{</span>
<span class="linenr"> 2: </span>  <span style="color: #268bd2; font-weight: bold;">private</span> <span style="color: #af005f; font-weight: bold;">boolean</span><span style="color: #8700af;">[]</span> <span style="color: #af5fd7;">flag</span> = <span style="color: #268bd2; font-weight: bold;">new</span> <span style="color: #af005f; font-weight: bold;">boolean</span><span style="color: #8700af;">[</span><span style="color: #8700af;">2</span><span style="color: #8700af;">]</span>;
<span class="linenr"> 3: </span>
<span class="linenr"> 4: </span>  <span style="color: #268bd2; font-weight: bold;">public</span> <span style="color: #af005f; font-weight: bold;">void</span> <span style="color: #8700af; font-weight: bold;">lock</span><span style="color: #8700af;">()</span> <span style="color: #8700af;">{</span>
<span class="linenr"> 5: </span>    <span style="color: #af005f; font-weight: bold;">int</span> <span style="color: #af5fd7;">i</span> = ThreadID.get<span style="color: #2aa198;">()</span>;
<span class="linenr"> 6: </span>&#9654;   <span style="color: #af005f; font-weight: bold;">int</span> j = <span style="color: #8700af;">1</span>-i;
<span class="linenr"> 7: </span>    flag<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span> = <span style="color: #8700af;">true</span>;
<span class="linenr"> 8: </span>    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #2aa198;">(</span>flag<span style="color: #5faf00;">[</span>j<span style="color: #5faf00;">]</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{}</span>
<span class="linenr"> 9: </span>  <span style="color: #8700af;">}</span>
<span class="linenr">10: </span>
<span class="linenr">11: </span>  <span style="color: #268bd2; font-weight: bold;">public</span> <span style="color: #af005f; font-weight: bold;">void</span> <span style="color: #8700af; font-weight: bold;">unlock</span><span style="color: #8700af;">()</span> <span style="color: #8700af;">{</span>
<span class="linenr">12: </span>    <span style="color: #af005f; font-weight: bold;">int</span> <span style="color: #af5fd7;">i</span> = ThreadID.get<span style="color: #2aa198;">()</span>;
<span class="linenr">13: </span>    flag<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span> = <span style="color: #8700af;">false</span>;
<span class="linenr">14: </span>  <span style="color: #8700af;">}</span>
<span class="linenr">15: </span><span style="color: #268bd2;">}</span>
</pre>
</div>

<aside class="notes">
<p>
&#x2026; then flips the bit to get the other id
</p>

</aside>
</section>
</section>
<section>
<section id="slide-orgheadline5">
<h3 id="orgheadline5"><code>LockOne</code> mutex</h3>
<p>
The Art of Multiprocessor Programming, 2.3.1
</p>

<p>
Maurice Herlihy &amp; Nir Shavit, 2012
</p>

<div class="org-src-container">

<pre  class="src src-java"><span class="linenr"> 1: </span><span style="color: #268bd2; font-weight: bold;">class</span> <span style="color: #af005f; font-weight: bold;">LockOne</span> <span style="color: #268bd2; font-weight: bold;">implements</span> <span style="color: #af005f; font-weight: bold;">Lock</span> <span style="color: #268bd2;">{</span>
<span class="linenr"> 2: </span>  <span style="color: #268bd2; font-weight: bold;">private</span> <span style="color: #af005f; font-weight: bold;">boolean</span><span style="color: #8700af;">[]</span> <span style="color: #af5fd7;">flag</span> = <span style="color: #268bd2; font-weight: bold;">new</span> <span style="color: #af005f; font-weight: bold;">boolean</span><span style="color: #8700af;">[</span><span style="color: #8700af;">2</span><span style="color: #8700af;">]</span>;
<span class="linenr"> 3: </span>
<span class="linenr"> 4: </span>  <span style="color: #268bd2; font-weight: bold;">public</span> <span style="color: #af005f; font-weight: bold;">void</span> <span style="color: #8700af; font-weight: bold;">lock</span><span style="color: #8700af;">()</span> <span style="color: #8700af;">{</span>
<span class="linenr"> 5: </span>    <span style="color: #af005f; font-weight: bold;">int</span> <span style="color: #af5fd7;">i</span> = ThreadID.get<span style="color: #2aa198;">()</span>;
<span class="linenr"> 6: </span>    <span style="color: #af005f; font-weight: bold;">int</span> <span style="color: #af5fd7;">j</span> = <span style="color: #8700af;">1</span>-i;
<span class="linenr"> 7: </span>&#9654;   flag<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span> = <span style="color: #8700af;">true</span>;
<span class="linenr"> 8: </span>    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #2aa198;">(</span>flag<span style="color: #5faf00;">[</span>j<span style="color: #5faf00;">]</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{}</span>
<span class="linenr"> 9: </span>  <span style="color: #8700af;">}</span>
<span class="linenr">10: </span>
<span class="linenr">11: </span>  <span style="color: #268bd2; font-weight: bold;">public</span> <span style="color: #af005f; font-weight: bold;">void</span> <span style="color: #8700af; font-weight: bold;">unlock</span><span style="color: #8700af;">()</span> <span style="color: #8700af;">{</span>
<span class="linenr">12: </span>    <span style="color: #af005f; font-weight: bold;">int</span> <span style="color: #af5fd7;">i</span> = ThreadID.get<span style="color: #2aa198;">()</span>;
<span class="linenr">13: </span>    flag<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span> = <span style="color: #8700af;">false</span>;
<span class="linenr">14: </span>  <span style="color: #8700af;">}</span>
<span class="linenr">15: </span><span style="color: #268bd2;">}</span>
</pre>
</div>

<aside class="notes">
<p>
each thread marks it's own flag as true
</p>

<p>
signals intent to enter the critical section
threads
</p>

</aside>
</section>
</section>
<section>
<section id="slide-orgheadline6">
<h3 id="orgheadline6"><code>LockOne</code> mutex</h3>
<p>
The Art of Multiprocessor Programming, 2.3.1
</p>

<p>
Maurice Herlihy &amp; Nir Shavit, 2012
</p>

<div class="org-src-container">

<pre  class="src src-java"><span class="linenr"> 1: </span><span style="color: #268bd2; font-weight: bold;">class</span> <span style="color: #af005f; font-weight: bold;">LockOne</span> <span style="color: #268bd2; font-weight: bold;">implements</span> <span style="color: #af005f; font-weight: bold;">Lock</span> <span style="color: #268bd2;">{</span>
<span class="linenr"> 2: </span>  <span style="color: #268bd2; font-weight: bold;">private</span> <span style="color: #af005f; font-weight: bold;">boolean</span><span style="color: #8700af;">[]</span> <span style="color: #af5fd7;">flag</span> = <span style="color: #268bd2; font-weight: bold;">new</span> <span style="color: #af005f; font-weight: bold;">boolean</span><span style="color: #8700af;">[</span><span style="color: #8700af;">2</span><span style="color: #8700af;">]</span>;
<span class="linenr"> 3: </span>
<span class="linenr"> 4: </span>  <span style="color: #268bd2; font-weight: bold;">public</span> <span style="color: #af005f; font-weight: bold;">void</span> <span style="color: #8700af; font-weight: bold;">lock</span><span style="color: #8700af;">()</span> <span style="color: #8700af;">{</span>
<span class="linenr"> 5: </span>    <span style="color: #af005f; font-weight: bold;">int</span> <span style="color: #af5fd7;">i</span> = ThreadID.get<span style="color: #2aa198;">()</span>;
<span class="linenr"> 6: </span>    <span style="color: #af005f; font-weight: bold;">int</span> <span style="color: #af5fd7;">j</span> = <span style="color: #8700af;">1</span>-i;
<span class="linenr"> 7: </span>    flag<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span> = <span style="color: #8700af;">true</span>;
<span class="linenr"> 8: </span>&#9654;   <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #2aa198;">(</span>flag<span style="color: #5faf00;">[</span>j<span style="color: #5faf00;">]</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{}</span>
<span class="linenr"> 9: </span>  <span style="color: #8700af;">}</span>
<span class="linenr">10: </span>
<span class="linenr">11: </span>  <span style="color: #268bd2; font-weight: bold;">public</span> <span style="color: #af005f; font-weight: bold;">void</span> <span style="color: #8700af; font-weight: bold;">unlock</span><span style="color: #8700af;">()</span> <span style="color: #8700af;">{</span>
<span class="linenr">12: </span>    <span style="color: #af005f; font-weight: bold;">int</span> <span style="color: #af5fd7;">i</span> = ThreadID.get<span style="color: #2aa198;">()</span>;
<span class="linenr">13: </span>    flag<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span> = <span style="color: #8700af;">false</span>;
<span class="linenr">14: </span>  <span style="color: #8700af;">}</span>
<span class="linenr">15: </span><span style="color: #268bd2;">}</span>
</pre>
</div>

<aside class="notes">
<p>
each thread then checks the <b>other</b> thread's flag
</p>

<p>
if the other thread's flag is set, it waits
</p>

<p>
otherwise it the lock method returns, meaning it's ok to proceed
into some protected critical section of the code
</p>

</aside>
</section>
</section>
<section>
<section id="slide-orgheadline7">
<h3 id="orgheadline7"><code>LockOne</code> mutex</h3>
<p>
The Art of Multiprocessor Programming, 2.3.1
</p>

<p>
Maurice Herlihy &amp; Nir Shavit, 2012
</p>

<div class="org-src-container">

<pre  class="src src-java"><span class="linenr"> 1: </span><span style="color: #268bd2; font-weight: bold;">class</span> <span style="color: #af005f; font-weight: bold;">LockOne</span> <span style="color: #268bd2; font-weight: bold;">implements</span> <span style="color: #af005f; font-weight: bold;">Lock</span> <span style="color: #268bd2;">{</span>
<span class="linenr"> 2: </span>  <span style="color: #268bd2; font-weight: bold;">private</span> <span style="color: #af005f; font-weight: bold;">boolean</span><span style="color: #8700af;">[]</span> <span style="color: #af5fd7;">flag</span> = <span style="color: #268bd2; font-weight: bold;">new</span> <span style="color: #af005f; font-weight: bold;">boolean</span><span style="color: #8700af;">[</span><span style="color: #8700af;">2</span><span style="color: #8700af;">]</span>;
<span class="linenr"> 3: </span>
<span class="linenr"> 4: </span>  <span style="color: #268bd2; font-weight: bold;">public</span> <span style="color: #af005f; font-weight: bold;">void</span> <span style="color: #8700af; font-weight: bold;">lock</span><span style="color: #8700af;">()</span> <span style="color: #8700af;">{</span>
<span class="linenr"> 5: </span>    <span style="color: #af005f; font-weight: bold;">int</span> <span style="color: #af5fd7;">i</span> = ThreadID.get<span style="color: #2aa198;">()</span>;
<span class="linenr"> 6: </span>    <span style="color: #af005f; font-weight: bold;">int</span> <span style="color: #af5fd7;">j</span> = <span style="color: #8700af;">1</span>-i;
<span class="linenr"> 7: </span>&#9654;   flag<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span> = <span style="color: #8700af;">true</span>;
<span class="linenr"> 8: </span>&#9654;   <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #2aa198;">(</span>flag<span style="color: #5faf00;">[</span>j<span style="color: #5faf00;">]</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{}</span>
<span class="linenr"> 9: </span>  <span style="color: #8700af;">}</span>
<span class="linenr">10: </span>
<span class="linenr">11: </span>  <span style="color: #268bd2; font-weight: bold;">public</span> <span style="color: #af005f; font-weight: bold;">void</span> <span style="color: #8700af; font-weight: bold;">unlock</span><span style="color: #8700af;">()</span> <span style="color: #8700af;">{</span>
<span class="linenr">12: </span>    <span style="color: #af005f; font-weight: bold;">int</span> <span style="color: #af5fd7;">i</span> = ThreadID.get<span style="color: #2aa198;">()</span>;
<span class="linenr">13: </span>    flag<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span> = <span style="color: #8700af;">false</span>;
<span class="linenr">14: </span>  <span style="color: #8700af;">}</span>
<span class="linenr">15: </span><span style="color: #268bd2;">}</span>
</pre>
</div>

<aside class="notes">
<ul>
<li>these two operations are critical</li>

<li>The proof of mutual exclusion in the book requires that these two lines execute in program order</li>

</ul>

<p>
"program order" is just the order they are written down in the program
</p>

</aside>

</section>
</section>
<section>
<section id="slide-orgheadline8">
<h3 id="orgheadline8">good execution</h3>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Thread 0</th>
<th scope="col" class="org-left">Thread 1</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>flag[0] = true</code></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>flag[1] : false</code></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left"><code>flag[1] = true</code></td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left"><code>flag[0] : true</code></td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">spin</td>
</tr>

<tr>
<td class="org-left">enter</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<aside class="notes">
<ul>
<li>assuming everything behaves as expected</li>
<li>example execution of two operations</li>

</ul>

</aside>

</section>
</section>
<section>
<section id="slide-orgheadline9">
<h3 id="orgheadline9">good execution</h3>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Thread 0</th>
<th scope="col" class="org-left">Thread 1</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>flag[0] = true</code></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><span class="hlght"> <code>flag[1] : false</code> </span></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left"><code>flag[1] = true</code></td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left"><span class="hlght"> <code>flag[0] : true</code> </span></td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">spin</td>
</tr>

<tr>
<td class="org-left">enter</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<aside class="notes">
<ul>
<li>key: no way to mix up the instructions s.t. both can acquire/proceed</li>

</ul>

</aside>
</section>
</section>
<section>
<section id="slide-orgheadline10">
<h3 id="orgheadline10">bad execution</h3>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Thread 0</th>
<th scope="col" class="org-left">Thread 1</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><span class="hlght"> <code>flag[0] = true</code> </span></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>flag[1] : false</code></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left"><code>flag[1] = true</code></td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left"><code>flag[0] : true</code></td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">spin</td>
</tr>

<tr>
<td class="org-left">enter</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<aside class="notes">
<ul>
<li>x86, ARM, and Power either store maybe be "reordered"</li>
<li>reasons: store buffering, literal OOE</li>

</ul>

</aside>

</section>
</section>
<section>
<section id="slide-orgheadline11">
<h3 id="orgheadline11">bad execution</h3>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Thread 0</th>
<th scope="col" class="org-left">Thread 1</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>flag[1] : false</code></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left"><code>flag[1] = true</code></td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left"><code>flag[0] : false</code></td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">enter</td>
</tr>

<tr>
<td class="org-left"><span class="hlght">  <code>flag[0] = true</code> </span></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">enter</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<aside class="notes">
<ul>
<li>if that happens we might see an execution like this</li>

</ul>

</aside>

</section>
</section>
<section>
<section id="slide-orgheadline12">
<h3 id="orgheadline12">bad execution</h3>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Thread 0</th>
<th scope="col" class="org-left">Thread 1</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><span class="hlght"> <code>flag[1] : false</code> </span></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left"><code>flag[1] = true</code></td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left"><span class="hlght"> <code>flag[0] : false</code> </span></td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">enter</td>
</tr>

<tr>
<td class="org-left"><code>flag[0] = true</code></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">enter</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<aside class="notes">
<ul>
<li>now possible for both flag checks to see <code>false</code></li>

</ul>

</aside>
</section>
</section>
<section>
<section id="slide-orgheadline13">
<h3 id="orgheadline13">bad execution</h3>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Thread 0</th>
<th scope="col" class="org-left">Thread 1</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>flag[1] : false</code></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left"><code>flag[1] = true</code></td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left"><code>flag[0] : false</code></td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left"><span class="hlght">  enter </span></td>
</tr>

<tr>
<td class="org-left"><code>flag[0] = true</code></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><span class="hlght">  enter </span></td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<aside class="notes">
<ul>
<li>then possible for both threads to proceed into the protected code</li>

</ul>

</aside>

</section>
</section>
<section>
<section id="slide-orgheadline14">
<h3 id="orgheadline14">traditional solutions</h3>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">solutions</th>
<th scope="col" class="org-left">semantics</th>
<th scope="col" class="org-left">error prone</th>
<th scope="col" class="org-left">overkill</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">sequential consistency</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">✓</td>
</tr>

<tr>
<td class="org-left"><code>volatile</code> modifier</td>
<td class="org-left">✓</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">✓</td>
</tr>

<tr>
<td class="org-left">memory fences</td>
<td class="org-left">✓</td>
<td class="org-left">✓</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<blockquote nil>
<p>
Pragma 2.3.1. In practice, the Boolean flag variables &#x2026; must
all be declared volatile to work properly.
</p>
</blockquote>

<aside class="notes">
<p>
traditional solutions:
</p>

<ul>
<li>sc</li>
<li>volatile (java)</li>
<li>memory fences (c/c++)</li>

</ul>

</aside>

</section>
</section>
<section>
<section id="slide-orgheadline15">
<h3 id="orgheadline15">traditional solutions</h3>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">solutions</th>
<th scope="col" class="org-left">semantics</th>
<th scope="col" class="org-left">error prone</th>
<th scope="col" class="org-left">overkill</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><span class="hlght"> sequential consistency </span></td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">✓</td>
</tr>

<tr>
<td class="org-left"><code>volatile</code> modifier</td>
<td class="org-left">✓</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">✓</td>
</tr>

<tr>
<td class="org-left">memory fences</td>
<td class="org-left">✓</td>
<td class="org-left">✓</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<blockquote nil>
<p>
Pragma 2.3.1. In practice, the Boolean flag variables &#x2026; must
all be declared volatile to work properly.
</p>
</blockquote>

<aside class="notes">
<ul>
<li>sc might be fine for code that calls these algorithms, but expensive here</li>
<li>many ops can safely reorder for performance</li>
<li>the algorithm will continue to work fine</li>

</ul>

</aside>

</section>
</section>
<section>
<section id="slide-orgheadline16">
<h3 id="orgheadline16">traditional solutions</h3>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">solutions</th>
<th scope="col" class="org-left">semantics</th>
<th scope="col" class="org-left">error prone</th>
<th scope="col" class="org-left">overkill</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">sequential consistency</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">✓</td>
</tr>

<tr>
<td class="org-left"><span class="hlght"> <code>volatile</code> modifier </span></td>
<td class="org-left">✓</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">✓</td>
</tr>

<tr>
<td class="org-left">memory fences</td>
<td class="org-left">✓</td>
<td class="org-left">✓</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<blockquote nil>
<p>
Pragma 2.3.1. In practice, the Boolean flag variables &#x2026; must
all be declared volatile to work properly.
</p>
</blockquote>

<aside class="notes">
<ul>
<li>note the pragma from the book</li>
<li>semantics
<ul>
<li>algorithm broken without guarantees</li>
<li>newcomer can't infer that from volatile</li>

</ul></li>
<li>every operation on volatile variables is affected, unnecessary</li>

</ul>

</aside>

</section>
</section>
<section>
<section id="slide-orgheadline17">
<h3 id="orgheadline17">traditional solutions</h3>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">solutions</th>
<th scope="col" class="org-left">semantics</th>
<th scope="col" class="org-left">error prone</th>
<th scope="col" class="org-left">overkill</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">sequential consistency</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">✓</td>
</tr>

<tr>
<td class="org-left"><code>volatile</code> modifier</td>
<td class="org-left">✓</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">✓</td>
</tr>

<tr>
<td class="org-left"><span class="hlght"> memory fences </span></td>
<td class="org-left">✓</td>
<td class="org-left">✓</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<blockquote nil>
<p>
Pragma 2.3.1. In practice, the Boolean flag variables &#x2026; must
all be declared volatile to work properly.
</p>
</blockquote>

<aside class="notes">
<ul>
<li>relates many instructions obscuring the reason for placement</li>
<li>you really need to know the docs to get these right</li>

</ul>

</aside>

</section>
</section>
<section>
<section id="slide-orgheadline18">
<h3 id="orgheadline18">traditional solutions</h3>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">solutions</th>
<th scope="col" class="org-left">semantics</th>
<th scope="col" class="org-left">error prone</th>
<th scope="col" class="org-left">overkill</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><span class="hlght"> sequential consistency </span></td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">✓</td>
</tr>

<tr>
<td class="org-left"><span class="hlght"> <code>volatile</code> modifier </span></td>
<td class="org-left">✓</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">✓</td>
</tr>

<tr>
<td class="org-left"><span class="hlght"> memory fences </span></td>
<td class="org-left">✓</td>
<td class="org-left">✓</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<blockquote nil>
<p>
Pragma 2.3.1. In practice, the Boolean flag variables &#x2026; must
all be declared volatile to work properly.
</p>
</blockquote>

<aside class="notes">
<ul>
<li>implementation details of a higher level concept</li>

</ul>

</aside>

</section>
</section>
<section>
<section id="slide-orgheadline19">
<h3 id="orgheadline19">execution order</h3>
<blockquote nil>
<p>
The requirement that two instructions appear to execute in program order.
</p>
</blockquote>

<aside class="notes">
<ul>
<li>simple but useful</li>
<li>higher level concept is the execution order</li>

</ul>

</aside>
</section>
</section>
<section>
<section id="slide-orgheadline20">
<h3 id="orgheadline20">algorithms = code + orders</h3>
<div class="org-src-container">

<pre  class="src src-java"><span class="linenr"> 1: </span><span style="color: #268bd2; font-weight: bold;">class</span> <span style="color: #af005f; font-weight: bold;">LockOne</span> <span style="color: #268bd2; font-weight: bold;">implements</span> <span style="color: #af005f; font-weight: bold;">Lock</span> <span style="color: #268bd2;">{</span>
<span class="linenr"> 2: </span>  <span style="color: #268bd2; font-weight: bold;">private</span> <span style="color: #af005f; font-weight: bold;">boolean</span><span style="color: #8700af;">[]</span> <span style="color: #af5fd7;">flag</span> = <span style="color: #268bd2; font-weight: bold;">new</span> <span style="color: #af005f; font-weight: bold;">boolean</span><span style="color: #8700af;">[</span><span style="color: #8700af;">2</span><span style="color: #8700af;">]</span>;
<span class="linenr"> 3: </span>
<span class="linenr"> 4: </span>  <span style="color: #268bd2; font-weight: bold;">public</span> <span style="color: #af005f; font-weight: bold;">void</span> <span style="color: #8700af; font-weight: bold;">lock</span><span style="color: #8700af;">()</span> <span style="color: #8700af;">{</span>
<span class="linenr"> 5: </span>    <span style="color: #af005f; font-weight: bold;">int</span> <span style="color: #af5fd7;">i</span> = ThreadID.get<span style="color: #2aa198;">()</span>;
<span class="linenr"> 6: </span>    <span style="color: #af005f; font-weight: bold;">int</span> <span style="color: #af5fd7;">j</span> = <span style="color: #8700af;">1</span>-i;
<span class="linenr"> 7: </span>&#9654;   flag<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span> = <span style="color: #8700af;">true</span>;
<span class="linenr"> 8: </span>&#9654;   <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #2aa198;">(</span>flag<span style="color: #5faf00;">[</span>j<span style="color: #5faf00;">]</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{}</span>
<span class="linenr"> 9: </span>  <span style="color: #8700af;">}</span>
<span class="linenr">10: </span>
<span class="linenr">11: </span>  <span style="color: #268bd2; font-weight: bold;">public</span> <span style="color: #af005f; font-weight: bold;">void</span> <span style="color: #8700af; font-weight: bold;">unlock</span><span style="color: #8700af;">()</span> <span style="color: #8700af;">{</span>
<span class="linenr">12: </span>    <span style="color: #af005f; font-weight: bold;">int</span> <span style="color: #af5fd7;">i</span> = ThreadID.get<span style="color: #2aa198;">()</span>;
<span class="linenr">13: </span>    flag<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span> = <span style="color: #8700af;">false</span>;
<span class="linenr">14: </span>  <span style="color: #8700af;">}</span>
<span class="linenr">15: </span><span style="color: #268bd2;">}</span>
</pre>
</div>
<p>

   <span class="plus">+</span>
   <div class="order">
   
\(\{ 7 \rightarrow 8, ... \}\)

   </div>
   
</p>

<aside class="notes">
<ul>
<li>LockOne not finished without orders!</li>
<li>requires a side note in the book about <code>volatile</code></li>
<li>o/w it doesn't work properly</li>
<li>"so the algorithim is in fact code plus a set of orders"</li>

</ul>

</aside>

</section>
</section>
<section>
<section id="slide-orgheadline23">
<h2 id="orgheadline23">Enforcing Orders</h2>
<aside class="notes">
<ul>
<li>how do we help implementers use orders?</li>
<li>fence insertion!</li>

</ul>

</aside>


<div class="figure">
<p><img src="./assets/images/xplatform.png" alt="xplatform.png" />
</p>
</div>


</section>
</section>
<section>
<section id="slide-orgheadline21">
<h3 id="orgheadline21">previous approaches</h3>
<ul>
<li>Insert fences to&#x2026;
<ul>
<li>enforce sequential consistency
<ul>
<li>Alglave and Kroening et al, CAV 2014</li>

</ul></li>
<li>enforce a specification
<ul>
<li>Kuperstein and Vechev et al, FMCAD 2010</li>

</ul></li>

</ul></li>
<li>Whole program, O(2<sup>n</sup>)</li>

</ul>

<aside class="notes">
<p>
SC: overkill in many cases
</p>

<p>
Spec:
</p>

<p>
Can be thought of as "finding the orders" necessary to ensure properties
</p>

<p>
some properties don't work well as specification
</p>

<p>
Orders exist as fragments of proofs which can't easily
be translated into specifications, eg stm correctness
</p>

<p>
Both: Whole program, don't scale well
</p>

<p>
SC: Don't Sit On the Fence, CAV'14, alglave et al
</p>

<p>
Spec: Automatic Inference of Memory Fences, FMCAD '10, Kuperstein et al
</p>

</aside>
</section>
</section>
<section>
<section id="slide-orgheadline22">
<h3 id="orgheadline22">our approach</h3>
<ul>
<li>Algorithm = code + orders</li>
<li>Insert fences to enforce orders</li>
<li>Per-procedure
<ul>
<li>still O(2<sup>n</sup>) but inputs are small</li>

</ul></li>
<li>See also
<ul>
<li>Crary and Sullivan, POPL 2015</li>

</ul></li>

</ul>

<aside class="notes">
<ul>
<li>Instead of inferring the orders from the program, we ask the programmer for them</li>
<li>This places our analysis at the procedure level.</li>
<li>A Calculus for Relaxed Memory Models, POPL 2015, Crary et al</li>
<li>they built the semantics, we built the tool</li>

</ul>

</aside>

</section>
</section>
<section>
<section id="slide-orgheadline32">
<h2 id="orgheadline32">Fence Insertion Subtleties</h2>
<aside class="notes">
<p>
We have an idea of what we think algorithms should look like,
what's standing in our way?
</p>

</aside>
</section>
</section>
<section>
<section id="slide-orgheadline24">
<h3 id="orgheadline24">many platforms</h3>
<div class="org-src-container">

<pre  class="src src-c++"><span style="color: #af005f; font-weight: bold;">void</span> <span style="color: #8700af; font-weight: bold;">lock</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
  <span style="color: #af005f; font-weight: bold;">int</span> <span style="color: #af5fd7;">i</span> = get_thread_id<span style="color: #8700af;">()</span>;
  <span style="color: #af005f; font-weight: bold;">int</span> <span style="color: #af5fd7;">j</span> = <span style="color: #8700af;">1</span>-i;
  flag<span style="color: #8700af;">[</span>i<span style="color: #8700af;">]</span> = <span style="color: #8700af;">true</span>;

&#9654; <span style="color: #268bd2; font-weight: bold;">__asm__</span> <span style="color: #8700af;">(</span><span style="color: #2aa198;">"mfence"</span><span style="color: #8700af;">)</span>; <span style="color: #008787; background-color: #ffffff;">// </span><span style="color: #008787; background-color: #ffffff;">x86</span>
&#9654; <span style="color: #268bd2; font-weight: bold;">__asm__</span> <span style="color: #8700af;">(</span><span style="color: #2aa198;">"dmb"</span><span style="color: #8700af;">)</span>;    <span style="color: #008787; background-color: #ffffff;">// </span><span style="color: #008787; background-color: #ffffff;">ARMv7</span>

  <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #8700af;">(</span>flag<span style="color: #2aa198;">[</span>j<span style="color: #2aa198;">]</span><span style="color: #8700af;">)</span> <span style="color: #8700af;">{}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>

<aside class="notes">
<p>
assuming we're programming at the level of C/C++ we need to use an
architecture appropriate fence instruction to ensure the two orders
defined in the proof
</p>

</aside>

</section>
</section>
<section>
<section id="slide-orgheadline25">
<h3 id="orgheadline25">fence selection</h3>
<div class="org-src-container">

<pre  class="src src-c++"><span style="color: #af005f; font-weight: bold;">void</span> <span style="color: #8700af; font-weight: bold;">lock</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
  <span style="color: #af005f; font-weight: bold;">int</span> <span style="color: #af5fd7;">i</span> = get_thread_id<span style="color: #8700af;">()</span>;
  <span style="color: #af005f; font-weight: bold;">int</span> <span style="color: #af5fd7;">j</span> = <span style="color: #8700af;">1</span>-i;
  flag<span style="color: #8700af;">[</span>i<span style="color: #8700af;">]</span> = <span style="color: #8700af;">true</span>;

&#9654; <span style="color: #268bd2; font-weight: bold;">__asm__</span> <span style="color: #8700af;">(</span><span style="color: #2aa198;">"dmb"</span><span style="color: #8700af;">)</span>;
&#9654; <span style="color: #268bd2; font-weight: bold;">__asm__</span> <span style="color: #8700af;">(</span><span style="color: #2aa198;">"dmb st"</span><span style="color: #8700af;">)</span>; <span style="color: #008787; background-color: #ffffff;">// </span><span style="color: #008787; background-color: #ffffff;">may be faster</span>

  <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #8700af;">(</span>flag<span style="color: #2aa198;">[</span>j<span style="color: #2aa198;">]</span><span style="color: #8700af;">)</span> <span style="color: #8700af;">{}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>

<aside class="notes">
<p>
different paired instructions may require different fences,
optimizing for performance
</p>

</aside>

</section>
</section>
<section>
<section id="slide-orgheadline26">
<h3 id="orgheadline26">existing fence(-likes)</h3>
<div class="org-src-container">

<pre  class="src src-c++"><span style="color: #af005f; font-weight: bold;">void</span> <span style="color: #8700af; font-weight: bold;">lock</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
  <span style="color: #af005f; font-weight: bold;">int</span> <span style="color: #af5fd7;">i</span> = get_thread_id<span style="color: #8700af;">()</span>;
  <span style="color: #af005f; font-weight: bold;">int</span> <span style="color: #af5fd7;">j</span> = <span style="color: #8700af;">1</span>-i;

  <span style="color: #008787; background-color: #ffffff;">// </span><span style="color: #008787; background-color: #ffffff;">x86:   cmpxchg</span>
  <span style="color: #008787; background-color: #ffffff;">// </span><span style="color: #008787; background-color: #ffffff;">ARMv7: ldrex/strex</span>
&#9654; CAS<span style="color: #8700af;">(</span>flag<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span>, <span style="color: #8700af;">false</span>, <span style="color: #8700af;">true</span><span style="color: #8700af;">)</span>;

  <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #8700af;">(</span>flag<span style="color: #2aa198;">[</span>j<span style="color: #2aa198;">]</span><span style="color: #8700af;">)</span> <span style="color: #8700af;">{}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>

<aside class="notes">
<p>
there are other instructions like `cmpxhg` which have fence like
semantics that we should account for (by avoiding adding more fences).
</p>

</aside>

</section>
</section>
<section>
<section id="slide-orgheadline27">
<h3 id="orgheadline27">TL2 STM Algorithm</h3>
<div class="org-src-container">

<pre  class="src src-c">  ...

<span style="color: #8700af;">  # if</span><span style="color: #8700af;">n</span><span style="color: #8700af;">def</span> TL2_EAGER
  <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #268bd2;">(</span>wr = logs; wr != end; wr++<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #008787; background-color: #ffffff;">// </span><span style="color: #008787; background-color: #ffffff;">write the deferred stores</span>
&#9654;   WriteBackForward<span style="color: #8700af;">(</span>wr<span style="color: #8700af;">)</span>;
  <span style="color: #268bd2;">}</span>
<span style="color: #8700af;">  # endif</span>

  <span style="color: #008787; background-color: #ffffff;">// </span><span style="color: #008787; background-color: #ffffff;">make stores visible before unlock</span>
  MEMBARSTST<span style="color: #268bd2;">()</span>;

  <span style="color: #008787; background-color: #ffffff;">// </span><span style="color: #008787; background-color: #ffffff;">release locks and increment version</span>
  DropLocks<span style="color: #268bd2;">(</span>Self, wv<span style="color: #268bd2;">)</span>;

  ...
</pre>
</div>

<aside class="notes">
<ul>
<li>this is code from the tl2 transactional memory algorithm</li>
<li>avoiding details</li>
<li>there's a store to memory in the writebackforward</li>

</ul>

</aside>

</section>
</section>
<section>
<section id="slide-orgheadline28">
<h3 id="orgheadline28">TL2 STM Algorithm</h3>
<div class="org-src-container">

<pre  class="src src-c">  ...

<span style="color: #8700af;">  # if</span><span style="color: #8700af;">n</span><span style="color: #8700af;">def</span> TL2_EAGER
  <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #268bd2;">(</span>wr = logs; wr != end; wr++<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #008787; background-color: #ffffff;">// </span><span style="color: #008787; background-color: #ffffff;">write the deferred stores</span>
    WriteBackForward<span style="color: #8700af;">(</span>wr<span style="color: #8700af;">)</span>;
  <span style="color: #268bd2;">}</span>
<span style="color: #8700af;">  # endif</span>

  <span style="color: #008787; background-color: #ffffff;">// </span><span style="color: #008787; background-color: #ffffff;">make stores visible before unlock</span>
  MEMBARSTST<span style="color: #268bd2;">()</span>;

  <span style="color: #008787; background-color: #ffffff;">// </span><span style="color: #008787; background-color: #ffffff;">release locks and increment version</span>
&#9654; DropLocks<span style="color: #268bd2;">(</span>Self, wv<span style="color: #268bd2;">)</span>;

  ...
</pre>
</div>

<aside class="notes">
<ul>
<li>must happen before the store in droplocks for the algo to work</li>

</ul>

</aside>
</section>
</section>
<section>
<section id="slide-orgheadline29">
<h3 id="orgheadline29">TL2 STM Algorithm</h3>
<div class="org-src-container">

<pre  class="src src-c">  ...

<span style="color: #8700af;">  # if</span><span style="color: #8700af;">n</span><span style="color: #8700af;">def</span> TL2_EAGER
  <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #268bd2;">(</span>wr = logs; wr != end; wr++<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #008787; background-color: #ffffff;">// </span><span style="color: #008787; background-color: #ffffff;">write the deferred stores</span>
    WriteBackForward<span style="color: #8700af;">(</span>wr<span style="color: #8700af;">)</span>;
  <span style="color: #268bd2;">}</span>
<span style="color: #8700af;">  # endif</span>

  <span style="color: #008787; background-color: #ffffff;">// </span><span style="color: #008787; background-color: #ffffff;">make stores visible before unlock</span>
&#9654; MEMBARSTST<span style="color: #268bd2;">()</span>;

  <span style="color: #008787; background-color: #ffffff;">// </span><span style="color: #008787; background-color: #ffffff;">release locks and increment version</span>
  DropLocks<span style="color: #268bd2;">(</span>Self, wv<span style="color: #268bd2;">)</span>;

  ...
</pre>
</div>

<aside class="notes">
<ul>
<li>the authors of the code add these fence macros</li>
<li>provide a way to define platform appropriate solution to prevent
stores from swapping</li>

</ul>

</aside>
</section>
</section>
<section>
<section id="slide-orgheadline30">
<h3 id="orgheadline30">code transformations</h3>
<div class="org-src-container">

<pre  class="src src-c">  ...

<span style="color: #8700af;">  # if</span><span style="color: #8700af;">n</span><span style="color: #8700af;">def</span> TL2_EAGER
&#9654; <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #268bd2;">(</span>wr = logs; wr != end; wr++<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
&#9654;   <span style="color: #008787; background-color: #ffffff;">// </span><span style="color: #008787; background-color: #ffffff;">write the deferred stores</span>
&#9654;   WriteBackForward<span style="color: #8700af;">(</span>wr<span style="color: #8700af;">)</span>;
&#9654; <span style="color: #268bd2;">}</span>
<span style="color: #8700af;">  # endif</span>

  <span style="color: #008787; background-color: #ffffff;">// </span><span style="color: #008787; background-color: #ffffff;">make stores visible before unlock</span>
  MEMBARSTST<span style="color: #268bd2;">()</span>;

  <span style="color: #008787; background-color: #ffffff;">// </span><span style="color: #008787; background-color: #ffffff;">release locks and increment version</span>
  DropLocks<span style="color: #268bd2;">(</span>Self, wv<span style="color: #268bd2;">)</span>;

  ...
</pre>
</div>

<aside class="notes">
<ul>
<li>if <code>TL2_EAGER</code> is defined will remove writebackforward</li>
<li>so the macro and fence becomes unnecessary</li>

</ul>

</aside>

</section>
</section>
<section>
<section id="slide-orgheadline31">
<h3 id="orgheadline31">faux order</h3>
<div class="org-src-container">

<pre  class="src src-c">  ...

<span style="color: #8700af;">  # if</span><span style="color: #8700af;">n</span><span style="color: #8700af;">def</span> TL2_EAGER
  <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #268bd2;">(</span>wr = logs; wr != end; wr++<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #008787; background-color: #ffffff;">// </span><span style="color: #008787; background-color: #ffffff;">write the deferred stores</span>
&#9654;   WriteBackForward<span style="color: #8700af;">(</span>wr<span style="color: #8700af;">)</span>;
  <span style="color: #268bd2;">}</span>
<span style="color: #8700af;">  # endif</span>

  <span style="color: #008787; background-color: #ffffff;">// </span><span style="color: #008787; background-color: #ffffff;">make stores visible before unlock</span>
  MEMBARSTST<span style="color: #268bd2;">()</span>;

  <span style="color: #008787; background-color: #ffffff;">// </span><span style="color: #008787; background-color: #ffffff;">release locks and increment version</span>
&#9654; DropLocks<span style="color: #268bd2;">(</span>Self, wv<span style="color: #268bd2;">)</span>;

  ...
</pre>
</div>

<aside class="notes">
<ul>
<li>more generally the implementers really wanted to define an order here</li>
<li>by using a fence macro anyone coming to the code has to have the algorithm
spec in hand to determine why that fence was placed</li>

</ul>

</aside>
</section>
</section>
<section>
<section id="slide-orgheadline45">
<h2 id="orgheadline45">Algorithm</h2>
<div class="outline-text-2" id="text-orgheadline45">
</div></section>
</section>
<section>
<section id="slide-orgheadline33">
<h3 id="orgheadline33">algorithm</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #268bd2; font-weight: bold;">def</span> <span style="color: #8700af; font-weight: bold;">Insert</span><span style="color: #268bd2;">(</span>G1, A, O1<span style="color: #268bd2;">)</span>:
      &#9650;
  <span style="color: #af5fd7;">O2</span> = O1 \ Elim<span style="color: #268bd2;">(</span>G, A, O1<span style="color: #268bd2;">)</span>

  <span style="color: #af5fd7;">K</span>  = Cut<span style="color: #268bd2;">(</span>G1, O2<span style="color: #268bd2;">)</span>

  <span style="color: #af5fd7;">G2</span> = Refine<span style="color: #268bd2;">(</span>G1, K<span style="color: #268bd2;">)</span>

  <span style="color: #268bd2; font-weight: bold;">return</span> G2
end
</pre>
</div>

<p>
 <div class="algo-graph">
</p>

<div class="figure">
<p><img src="assets/images/full-graph.png" alt="full-graph.png" />
</p>
</div>

<p>
 </div>
</p>

<aside class="notes">
<ul>
<li>our algorithm insert</li>
<li>left code, right inputs except for the architecture</li>

</ul>

</aside>

</section>
</section>
<section>
<section id="slide-orgheadline34">
<h3 id="orgheadline34">control flow graph</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #268bd2; font-weight: bold;">def</span> <span style="color: #8700af; font-weight: bold;">Insert</span><span style="color: #268bd2;">(</span>G1, A, O1<span style="color: #268bd2;">)</span>:
            &#9650;
  <span style="color: #af5fd7;">O2</span> = O1 \ Elim<span style="color: #268bd2;">(</span>G, A, O1<span style="color: #268bd2;">)</span>

  <span style="color: #af5fd7;">K</span>  = Cut<span style="color: #268bd2;">(</span>G1, O2<span style="color: #268bd2;">)</span>

  <span style="color: #af5fd7;">G2</span> = Refine<span style="color: #268bd2;">(</span>G1, K<span style="color: #268bd2;">)</span>

  <span style="color: #268bd2; font-weight: bold;">return</span> G2
end
</pre>
</div>

<p>
 <div class="algo-graph">
</p>

<div class="figure">
<p><img src="assets/images/full-graph-fst-input.png" alt="full-graph-fst-input.png" />
</p>
</div>

<p>
 </div>
</p>

<aside class="notes">
<ul>
<li>control flow graph for some simple procedure</li>

</ul>

</aside>
</section>
</section>
<section>
<section id="slide-orgheadline35">
<h3 id="orgheadline35">architecture spec</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #268bd2; font-weight: bold;">def</span> <span style="color: #8700af; font-weight: bold;">Insert</span><span style="color: #268bd2;">(</span>G1, A, O1<span style="color: #268bd2;">)</span>:
               &#9650;
  <span style="color: #af5fd7;">O2</span> = O1 \ Elim<span style="color: #268bd2;">(</span>G, A, O1<span style="color: #268bd2;">)</span>

  <span style="color: #af5fd7;">K</span>  = Cut<span style="color: #268bd2;">(</span>G1, O2<span style="color: #268bd2;">)</span>

  <span style="color: #af5fd7;">G2</span> = Refine<span style="color: #268bd2;">(</span>G1, K<span style="color: #268bd2;">)</span>

  <span style="color: #268bd2; font-weight: bold;">return</span> G2
end
</pre>
</div>

<p>
 <div class="algo-graph">
</p>


<div class="figure">
<p><img src="assets/images/full-graph.png" alt="full-graph.png" />
</p>
</div>

<p>
 </div>
</p>

<aside class="notes">
<ul>
<li>an architecture specification not pictured here</li>
<li>it tells us what the architecture WONT reorder</li>
<li>we'll assume ARM for the sake of the example</li>

</ul>

</aside>
</section>
</section>
<section>
<section id="slide-orgheadline36">
<h3 id="orgheadline36">orders</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #268bd2; font-weight: bold;">def</span> <span style="color: #8700af; font-weight: bold;">Insert</span><span style="color: #268bd2;">(</span>G1, A, O1<span style="color: #268bd2;">)</span>:
                   &#9650;
  <span style="color: #af5fd7;">O2</span> = O1 \ Elim<span style="color: #268bd2;">(</span>G, A, O1<span style="color: #268bd2;">)</span>

  <span style="color: #af5fd7;">K</span>  = Cut<span style="color: #268bd2;">(</span>G1, O2<span style="color: #268bd2;">)</span>

  <span style="color: #af5fd7;">G2</span> = Refine<span style="color: #268bd2;">(</span>G1, K<span style="color: #268bd2;">)</span>

  <span style="color: #268bd2; font-weight: bold;">return</span> G2
end
</pre>
</div>

<p>
 <div class="algo-graph">
</p>

<div class="figure">
<p><img src="assets/images/full-graph-third-input.png" alt="full-graph-third-input.png" />
</p>
</div>

<p>
 </div>
</p>

<aside class="notes">
<ul>
<li>set of orders that need to be enforced</li>

</ul>

</aside>
</section>
</section>
<section>
<section id="slide-orgheadline37">
<h3 id="orgheadline37">order elimination</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #268bd2; font-weight: bold;">def</span> <span style="color: #8700af; font-weight: bold;">Insert</span><span style="color: #268bd2;">(</span>G1, A, O1<span style="color: #268bd2;">)</span>:

&#9654; <span style="color: #af5fd7;">O2</span> = O1 \ Elim<span style="color: #268bd2;">(</span>G, A, O1<span style="color: #268bd2;">)</span>

  <span style="color: #af5fd7;">K</span>  = Cut<span style="color: #268bd2;">(</span>G1, O2<span style="color: #268bd2;">)</span>

  <span style="color: #af5fd7;">G2</span> = Refine<span style="color: #268bd2;">(</span>G1, K<span style="color: #268bd2;">)</span>

  <span style="color: #268bd2; font-weight: bold;">return</span> G2
end
</pre>
</div>

<p>
 <div class="algo-graph">
</p>

<div class="figure">
<p><img src="assets/images/full-graph-elim.png" alt="full-graph-elim.png" />
</p>
</div>

<p>
 </div>
</p>

<aside class="notes">
<ul>
<li>first step is order elimination</li>
<li>we want to avoid inserting fences where they are unnecessary</li>
<li>on arm (and every other architecture) a load won't move past a store to the same address</li>

</ul>

</aside>

</section>
</section>
<section>
<section id="slide-orgheadline38">
<h3 id="orgheadline38">order elimination</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #268bd2; font-weight: bold;">def</span> <span style="color: #8700af; font-weight: bold;">Insert</span><span style="color: #268bd2;">(</span>G1, A, O1<span style="color: #268bd2;">)</span>:

&#9654; <span style="color: #af5fd7;">O2</span> = O1 \ Elim<span style="color: #268bd2;">(</span>G, A, O1<span style="color: #268bd2;">)</span>

  <span style="color: #af5fd7;">K</span>  = Cut<span style="color: #268bd2;">(</span>G1, O2<span style="color: #268bd2;">)</span>

  <span style="color: #af5fd7;">G2</span> = Refine<span style="color: #268bd2;">(</span>G1, K<span style="color: #268bd2;">)</span>

  <span style="color: #268bd2; font-weight: bold;">return</span> G2
end
</pre>
</div>

<p>
 <div class="algo-graph">
</p>

<div class="figure">
<p><img src="assets/images/full-graph-elim-after.png" alt="full-graph-elim-after.png" />
</p>
</div>

<p>
 </div>
</p>

<aside class="notes">
<ul>
<li>so we can safely discard that order</li>

</ul>

</aside>

</section>
</section>
<section>
<section id="slide-orgheadline39">
<h3 id="orgheadline39">fence position</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #268bd2; font-weight: bold;">def</span> <span style="color: #8700af; font-weight: bold;">Insert</span><span style="color: #268bd2;">(</span>G1, A, O1<span style="color: #268bd2;">)</span>:

  <span style="color: #af5fd7;">O2</span> = O1 \ Elim<span style="color: #268bd2;">(</span>G, A, O1<span style="color: #268bd2;">)</span>

&#9654; <span style="color: #af5fd7;">K</span>  = Cut<span style="color: #268bd2;">(</span>G1, O2<span style="color: #268bd2;">)</span>

  <span style="color: #af5fd7;">G2</span> = Refine<span style="color: #268bd2;">(</span>G1, K<span style="color: #268bd2;">)</span>

  <span style="color: #268bd2; font-weight: bold;">return</span> G2
end
</pre>
</div>

<p>
 <div class="algo-graph">
 </div>
</p>

<aside class="notes">
<ul>
<li>the next step is finding good places for fences that will enforce the orders</li>

</ul>

</aside>

</section>
</section>
<section>
<section id="slide-orgheadline40">
<h3 id="orgheadline40">fence position</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #268bd2; font-weight: bold;">def</span> <span style="color: #8700af; font-weight: bold;">Insert</span><span style="color: #268bd2;">(</span>G1, A, O1<span style="color: #268bd2;">)</span>:

  <span style="color: #af5fd7;">O2</span> = O1 \ Elim<span style="color: #268bd2;">(</span>G, A, O1<span style="color: #268bd2;">)</span>

&#9654; <span style="color: #af5fd7;">K</span>  = Cut<span style="color: #268bd2;">(</span>G1, O2<span style="color: #268bd2;">)</span>

  <span style="color: #af5fd7;">G2</span> = Refine<span style="color: #268bd2;">(</span>G1, K<span style="color: #268bd2;">)</span>

  <span style="color: #268bd2; font-weight: bold;">return</span> G2
end
</pre>
</div>

<p>
 <div class="algo-graph">
</p>

<div class="figure">
<p><img src="assets/images/full-graph-cut-highlight.png" alt="full-graph-cut-highlight.png" />
</p>
</div>

<p>
 </div>
</p>

<aside class="notes">
<ul>
<li>we consider all the orders</li>
<li>use multicut to find an optimal set of edges to separate the sources from the sinks</li>

</ul>

</aside>

</section>
</section>
<section>
<section id="slide-orgheadline41">
<h3 id="orgheadline41">fence position</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #268bd2; font-weight: bold;">def</span> <span style="color: #8700af; font-weight: bold;">Insert</span><span style="color: #268bd2;">(</span>G1, A, O1<span style="color: #268bd2;">)</span>:

  <span style="color: #af5fd7;">O2</span> = O1 \ Elim<span style="color: #268bd2;">(</span>G, A, O1<span style="color: #268bd2;">)</span>

&#9654; <span style="color: #af5fd7;">K</span>  = Cut<span style="color: #268bd2;">(</span>G1, O2<span style="color: #268bd2;">)</span>

  <span style="color: #af5fd7;">G2</span> = Refine<span style="color: #268bd2;">(</span>G1, K<span style="color: #268bd2;">)</span>

  <span style="color: #268bd2; font-weight: bold;">return</span> G2
end
</pre>
</div>

<p>
 <div class="algo-graph">
</p>

<div class="figure">
<p><img src="assets/images/full-graph-cut-highlight-2.png" alt="full-graph-cut-highlight-2.png" />
</p>
</div>

<p>
 </div>
</p>

<aside class="notes">
<ul>
<li>so our cut set K is just the one edge between the two stores</li>

</ul>

</aside>

</section>
</section>
<section>
<section id="slide-orgheadline42">
<h3 id="orgheadline42">fence placement</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #268bd2; font-weight: bold;">def</span> <span style="color: #8700af; font-weight: bold;">Insert</span><span style="color: #268bd2;">(</span>G1, A, O1<span style="color: #268bd2;">)</span>:

  <span style="color: #af5fd7;">O2</span> = O1 \ Elim<span style="color: #268bd2;">(</span>G, A, O1<span style="color: #268bd2;">)</span>

  <span style="color: #af5fd7;">K</span>  = Cut<span style="color: #268bd2;">(</span>G1, O2<span style="color: #268bd2;">)</span>

&#9654; <span style="color: #af5fd7;">G2</span> = Refine<span style="color: #268bd2;">(</span>G1, K<span style="color: #268bd2;">)</span>

  <span style="color: #268bd2; font-weight: bold;">return</span> G2
end
</pre>
</div>

<p>
 <div class="algo-graph">
 </div>
</p>

<aside class="notes">
<ul>
<li>finally we use the cut set to place fences in the control flow graph</li>

</ul>

</aside>

</section>
</section>
<section>
<section id="slide-orgheadline43">
<h3 id="orgheadline43">fence placement</h3>
<div class="org-src-container">

<pre  class="src src-python"><span style="color: #268bd2; font-weight: bold;">def</span> <span style="color: #8700af; font-weight: bold;">Insert</span><span style="color: #268bd2;">(</span>G1, A, O1<span style="color: #268bd2;">)</span>:

  <span style="color: #af5fd7;">O2</span> = O1 \ Elim<span style="color: #268bd2;">(</span>G, A, O1<span style="color: #268bd2;">)</span>

  <span style="color: #af5fd7;">K</span>  = Cut<span style="color: #268bd2;">(</span>G1, O2<span style="color: #268bd2;">)</span>

&#9654; <span style="color: #af5fd7;">G2</span> = Refine<span style="color: #268bd2;">(</span>G1, K<span style="color: #268bd2;">)</span>

  <span style="color: #268bd2; font-weight: bold;">return</span> G2
end
</pre>
</div>

<p>
 <div class="algo-graph">
</p>

<div class="figure">
<p><img src="assets/images/full-graph-refine-apply.png" alt="full-graph-refine-apply.png" />
</p>
</div>

<p>
 </div>
</p>

</section>
</section>
<section>
<section id="slide-orgheadline44">
<h3 id="orgheadline44">main theorem</h3>
<p>
\(\mathsf{Insert}(G, A, O), A \vDash O\)
</p>

<aside class="notes">
<p>
intuitively, Given a graph, architecture and orders <code>insert</code>
will produce a graph that, assuming the same architecture
will enforce the orders
</p>

</aside>

</section>
</section>
<section>
<section id="slide-orgheadline55">
<h2 id="orgheadline55">Results/Parry</h2>
<aside class="notes">
<ul>
<li>we built a tool called Parry</li>
<li>see how well this idea can be implemented</li>

</ul>

</aside>
</section>
</section>
<section>
<section id="slide-orgheadline46">
<h3 id="orgheadline46">benchmark: classic algorithms</h3>
<ul>
<li>from Algave et al, CAV 2014</li>
<li>4 lock free algorithms</li>
<li>x86 and ARMv7</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline47">
<h3 id="orgheadline47">benchmark: STM algorithms</h3>
<ul>
<li>TL2/TL2 Eager</li>
<li>Rochester ByteEager (TLRW)</li>
<li>x86 and ARMv7</li>

</ul>

<aside class="notes">
<ul>
<li>TL2/TL2 Eager
<ul>
<li>included with STAMP Benchmarks</li>

</ul></li>
<li>RSTM ByteEager
<ul>
<li>part of Rochester STM Algorithm Suite</li>
<li>Michael Scott</li>

</ul></li>

</ul>

</aside>

</section>
</section>
<section>
<section id="slide-orgheadline48">
<h3 id="orgheadline48">benchmark: STM algorithms</h3>
<ul>
<li>TL2/TL2 Eager</li>
<li>Rochester ByteEager (TLRW)</li>
<li>x86 and <span class="hlght"> ARMv7 </span></li>

</ul>


<aside class="notes">
<ul>
<li>for the sake of time arm7 only</li>

</ul>

</aside>
</section>
</section>
<section>
<section id="slide-orgheadline49">
<h3 id="orgheadline49">benchmark: STM algorithms</h3>
<ul>
<li><b>baseline</b>: original fences</li>
<li><b>Parry</b>: fences placed by Parry</li>
<li>STAMP for performance</li>

</ul>

<aside class="notes">
<ul>
<li>baseline is fences already placed in algorithms</li>
<li>ours is fences placed by parry using orders from algorithm definitions</li>

<li>TL2 is the largest in terms of procedure size</li>
<li>TxCommit method has nearly 400 nodes</li>
<li>Just under 30s to run for 3 procedures in TL2</li>

</ul>

</aside>
</section>
</section>
<section>
<section id="slide-orgheadline50">
<h3 id="orgheadline50">tl2 - ARMv7</h3>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">baseline</td>
<td class="org-left">Parry</td>
</tr>

<tr>
<td class="org-left"><b><code>TxStore</code></b></td>
<td class="org-left"><span class="hlght"> 1920: <code>dmb</code> </span></td>
<td class="org-left"><span class="hlght"> 1886: <code>dmb</code> </span></td>
</tr>
</tbody>
</table>


<aside class="notes">
<p>
TxStore: we placed our fence "further up" the control flow graph,
this is dues to the way the multicut algorithm handles a sequence
of similarly weighted edges, choosing the first
</p>

</aside>

</section>
</section>
<section>
<section id="slide-orgheadline51">
<h3 id="orgheadline51">tl2 eager - ARMv7</h3>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">baseline</td>
<td class="org-left">Parry</td>
</tr>

<tr>
<td class="org-left"><b><code>TxCommit</code></b></td>
<td class="org-left"><span class="hlght"> 1669: <code>dmb st</code> </span></td>
<td class="org-left"><span class="hlght">  — </span></td>
</tr>
</tbody>
</table>

<aside class="notes">
<p>
Not that due to the ifdefs we saw in the example earlier we are
able to eliminate the stst fence at line 1669 on arm
</p>

</aside>

</section>
</section>
<section>
<section id="slide-orgheadline52">
<h3 id="orgheadline52">rstm - ARMv7</h3>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">baseline</td>
<td class="org-left">Parry</td>
</tr>

<tr>
<td class="org-left"><b><code>read_rw</code></b></td>
<td class="org-left"><span class="hlght"> 163: <code>ldrex/strex</code> </span></td>
<td class="org-left"><span class="hlght"> 163: <code>dmb st</code> </span></td>
</tr>
</tbody>
</table>

<aside class="notes">
<p>
in the <code>read_rw</code> method of the RSTM ByteEager algorithm they use a
compare and swap to enforce a store/store order
</p>

</aside>

</section>
</section>
<section>
<section id="slide-orgheadline53">
<h3 id="orgheadline53">tl2 performance</h3>

<div class="figure">
<p><img src="./assets/images/stamp-arm-tl2.png" alt="stamp-arm-tl2.png" />
</p>
</div>

<aside class="notes">
<ul>
<li>STAMP results for TL2 on ARM</li>
<li>Gray bars are Parry</li>
<li>matched hand placed fences</li>

</ul>

</aside>
</section>
</section>
<section>
<section id="slide-orgheadline54">
<h3 id="orgheadline54">rstm performance</h3>

<div class="figure">
<p><img src="./assets/images/stamp-arm-rstm.png" alt="stamp-arm-rstm.png" />
</p>
</div>

<aside class="notes">
<ul>
<li>STAMP results for RSTM/byteeager on ARM</li>
<li>verified that slower due to the pairing of a store/dmb st fence</li>
<li>suggests ldrex/strex can be faster in some circumstances</li>

</ul>

</aside>

</section>
</section>
<section>
<section id="slide-orgheadline56">
<h2 id="orgheadline56">algorithms = code + orders</h2>
<ul>
<li>Describe the algorithm behavior</li>
<li>Let the compiler enforce the orders</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline57">
<h2 id="orgheadline57">Thanks!</h2>
</section>
</section>
</div>
</div>
<script src="assets/reveal/lib/js/head.min.js"></script>
<script src="assets/reveal/js/reveal.js"></script>

<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({

controls: false,
progress: true,
history: true,
center: true,
slideNumber: 'c',
rollingLinks: false,
keyboard: true,
overview: true,

theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
transition: Reveal.getQueryHash().transition || 'none', // default/cube/page/concave/zoom/linear/fade/none
transitionSpeed: 'default',
multiplex: {
    secret: '', // null if client
    id: '', // id, obtained from socket.io server
    url: '' // Location of socket.io server
},

// Optional libraries used to extend on reveal.js
dependencies: [
 { src: 'assets/reveal/lib/js/classList.js', condition: function() { return !document.body.classList; } },
 { src: 'assets/reveal/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
 { src: 'assets/reveal/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
 { src: 'assets/reveal/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
 { src: 'assets/reveal/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }]
});
</script>
</body>
</html>
